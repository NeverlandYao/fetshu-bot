# TODO

## 异步 ACK 模式（Webhook 快速 ACK + 后台回复）

状态：待评估与排期

目标：Webhook 收到飞书事件后立即返回 200，业务逻辑在后台异步执行，避免飞书重试导致的重复处理与响应延迟。

- 将 `src/api/webhook.py` 的 `feishu_webhook` 路由改为快速 ACK：收到事件直接返回 `{"challenge": ..., "code": 0}` 或 `{"code": 0}`。
- 使用后台任务处理 Coze 调用与飞书回复：
  - 方案 A：FastAPI `BackgroundTasks`（轻量，易集成）。
  - 方案 B：任务队列（如 `RQ`/`Celery` + Redis），增强可靠性与重试能力。
- 幂等性与去重：
  - 以 `event_id` 作为幂等键，持久化到缓存（Redis），TTL 10–30 分钟。
  - 在后台任务与 Webhook 层都进行去重校验，避免“并发双处理”。
- 重试策略与错误处理：
  - 后台任务失败时采用指数退避重试（如 3 次，最大 2 分钟）。
  - 记录错误日志并输出结构化事件（便于排查）。
- 飞书接口调用优化：
  - 统一封装发送消息与回复接口，增加速率限制与失败报警（如达到阈值时告警）。
- 观测与指标：
  - 统计处理耗时、成功率、重试次数、丢弃事件数量。
- 配置项：
  - 新增 `ASYNC_ACK_ENABLED`（开关），以及队列/缓存连接参数（如 `REDIS_URL`）。
- 测试与验证：
  - 本地模拟飞书事件与重试场景，验证快速 ACK 与后台回复链路。
  - 编写集成测试覆盖幂等与重试逻辑。